(this.webpackJsonprandomgame=this.webpackJsonprandomgame||[]).push([[0],{405:function(e,t,i){e.exports=i(444)},409:function(e,t,i){},441:function(e,t){},444:function(e,t,i){"use strict";i.r(t);var n=i(37),s=i.n(n),a=i(402),o=i.n(a),r=(i(409),i(97)),u=i(98),h=i(139),c=i(166),l=(i(343),i(38)),d=i(367),y=i(158),f=i(229),v=i.n(f),p=i(340),m=i(368),g=i(341),k=i(121),x={player:{filename:"Character.png",width:57,animations:{default:{start:0,end:0,type:"frame"},walking:{start:0,end:7,type:"loop"},inventory_opening:{start:8,end:11,type:"once"},inventory_open:{start:11,end:11,type:"frame"},inventory_closing:{start:11,end:8,type:"once"},equip:{start:12,end:19,type:"once"},unequip:{start:19,end:12,type:"once"},mine:{start:20,end:22,type:"boomerang"},eat:{start:23,end:51,type:"once"},interact:{start:52,end:56,type:"once"}}}},b=Object.values(x).map((function(e){return e.filename}));b=b.filter((function(e,t){return b.indexOf(e)===t}));var w={},S=0,O="/randomgame/resources/textures/";function j(e,t){var i=new l.q("mat",t);return i.emissiveTexture=e,i.opacityTexture=e,i}var E=function(){function e(){Object(r.a)(this,e),this.scene=null,this.mesh=null,this.position=l.t.Zero()}return Object(u.a)(e,[{key:"attachBabylon",value:function(e){return this.scene=e,this}},{key:"tick",value:function(e){}},{key:"setVisibility",value:function(e){this.mesh&&this.mesh.setEnabled(e)}}]),e}(),T=function(){function e(t,i){var n=this,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"default";Object(r.a)(this,e),this.textureAtlas=void 0,this.texture=void 0,this.animationQueue=[],this.frame=0,this.direction=1,this.interval=void 0,this.textureScale=1,this.textureAtlas=t,this.textureScale=1/x[t].width;var a=new l.r(O+x[t].filename,i,!1,!0,l.r.NEAREST_NEAREST);a.uOffset=this.textureScale*x[t].animations[s].start,a.vOffset=0,a.uScale=this.textureScale,a.vScale=1,a.hasAlpha=!0,this.texture=a,this.queueAnimation(s),this.interval=setInterval((function(){return n.tick()}),80),window.texture=this}return Object(u.a)(e,[{key:"getTexture",value:function(){return this.texture}},{key:"isLast",value:function(e){return this.animationQueue[this.animationQueue.length-1].texture===e}},{key:"queueAnimation",value:function(e,t){if(!Object.keys(x[this.textureAtlas].animations).includes(e))return console.warn("Animation does not exist"),void this.animationQueue.push({texture:"default",skippable:!0});this.animationQueue.length>1&&this.animationQueue[this.animationQueue.length-1].skippable?this.animationQueue[this.animationQueue.length-1]={texture:e,skippable:!t}:this.animationQueue.push({texture:e,skippable:!t})}},{key:"tick",value:function(){if(this.texture){this.frame+=this.direction;var e=x[this.textureAtlas].animations[this.animationQueue[0].texture],t=Math.abs(e.start-e.end),i=this.animationQueue.length>1;if(this.frame>t)switch(e.type){case"loop":this.direction=1,this.frame=0,i&&this.animationQueue.shift();break;case"once":this.direction=1,i?(this.frame=0,this.animationQueue.shift()):this.frame=t;break;case"boomerang":this.direction=-1,this.frame-=2;break;case"frame":this.direction=1,this.frame=0,i&&this.animationQueue.shift()}this.frame<0&&(this.direction=1,i?(this.frame=0,this.animationQueue.shift()):this.frame=0);var n=x[this.textureAtlas].animations[this.animationQueue[0].texture],s=n.start>n.end?-1:1;this.texture.uOffset=(this.frame*s+n.start)*this.textureScale}else console.error("Texture is null")}}]),e}(),B=function(e){Object(h.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this)).id=e,n.velocityX=0,n.velocityY=0,n.targetX=0,n.targetY=0,n.finalVelocityX=0,n.finalVelocityY=0,n.targetTime=-1,n.keyBindings={up:0,down:0,left:0,right:0},n.keysPressed=[],n.texture=void 0,n}return Object(u.a)(i,[{key:"serialize",value:function(){return{x:this.position.x,y:this.position.y,velocityX:this.velocityX,velocityY:this.velocityY}}},{key:"deserialize",value:function(e,t){t?(this.targetX=e.x,this.targetY=e.y,this.finalVelocityX=e.velocityX,this.finalVelocityY=e.velocityY,this.targetTime=50,this.velocityX=(e.x-this.position.x)/50,this.velocityY=(e.y-this.position.y)/50):(this.position.x=e.x,this.position.y=e.y,this.velocityX=e.velocityX,this.velocityY=e.velocityY)}},{key:"tick",value:function(e){if(this.targetTime>0)return this.position.x+=this.velocityX*e,this.position.y+=this.velocityY*e,this.targetTime-=e,this.targetTime<=0&&(this.position.x=this.targetX,this.position.y=this.targetY,this.velocityX=this.finalVelocityX,this.velocityY=this.finalVelocityY),void this.updateMesh();if(!this.keyBindings.up&&!this.keyBindings.down&&!this.keyBindings.left&&!this.keyBindings.right)return this.position.x+=this.velocityX,this.position.y+=this.velocityY,void this.updateMesh();var t=.1*e,i=!1,n=!1,s=Math.sqrt(2);(this.keysPressed.includes(this.keyBindings.left)||this.keysPressed.includes(this.keyBindings.right))&&(i=!0),(this.keysPressed.includes(this.keyBindings.up)||this.keysPressed.includes(this.keyBindings.down))&&(n=!0),this.keysPressed.includes(this.keyBindings.left)&&(this.velocityX-=.2*t/(n?s:1)),this.keysPressed.includes(this.keyBindings.right)&&(this.velocityX+=.2*t/(n?s:1)),this.keysPressed.includes(this.keyBindings.up)&&(this.velocityY-=.2*t/(i?s:1)),this.keysPressed.includes(this.keyBindings.down)&&(this.velocityY+=.2*t/(i?s:1)),this.position.x+=this.velocityX*t,this.position.y+=this.velocityY*t,this.velocityX*=Math.pow(.95,t),this.velocityY*=Math.pow(.95,t),Math.abs(this.velocityX)<.1&&(this.velocityX=0),Math.abs(this.velocityY)<.1&&(this.velocityY=0),this.updateMesh()}},{key:"keyDown",value:function(e){this.keysPressed.includes(e)||this.keysPressed.push(e)}},{key:"keyUp",value:function(e){this.keysPressed.includes(e)&&(this.keysPressed=this.keysPressed.filter((function(t){return t!==e})))}},{key:"bindKeys",value:function(e){this.keyBindings=Object(m.a)(Object(m.a)({},this.keyBindings),e)}},{key:"attachBabylon",value:function(e){if(Object(g.a)(Object(k.a)(i.prototype),"attachBabylon",this).call(this,e),!this.scene)return this;this.mesh=l.j.CreatePlane("player",{width:100,height:200,sideOrientation:l.i.FRONTSIDE},this.scene),this.texture=new T("player",this.scene,"default"),this.mesh.material=j(this.texture.getTexture(),this.scene);var t=l.j.CreatePlane("title",{width:120,height:25,sideOrientation:l.i.FRONTSIDE},this.scene);t.position=new l.u(0,110,-3);var n=new l.f("titleTexture",{width:120,height:25},this.scene,!0,l.r.BILINEAR_SAMPLINGMODE),s=n.getContext();return s.fillStyle="#000000AA",s.fillRect(0,0,n.getSize().width,n.getSize().height),s.font="18px Arial",s.textBaseline="middle",s.textAlign="center",s.fillStyle="#FFFFFF",s.fillText(this.id,n.getSize().width/2,n.getSize().height/2,n.getSize().width-20),n.update(),t.parent=this.mesh,t.material=j(n,this.scene),this.updateMesh(),this}},{key:"updateMesh",value:function(){var e=Object(p.a)(v.a.mark((function e(){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.mesh){e.next=2;break}return e.abrupt("return");case 2:this.mesh.position=new l.u(this.position.x,-this.position.y,-1),1,Math.abs(this.velocityX)>1||Math.abs(this.velocityY)>1?this.texture.isLast("walking")||this.texture.queueAnimation("walking"):this.texture.isLast("default")||this.texture.queueAnimation("default");case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),i}(E),C=function(e){Object(h.a)(i,e);var t=Object(c.a)(i);function i(e,n){var s;return Object(r.a)(this,i),(s=t.call(this)).ground=[[]],s.position=new l.t(e,n),s}return Object(u.a)(i,[{key:"serialize",value:function(){return{x:this.position.x,y:this.position.y,ground:this.ground}}},{key:"deserialize",value:function(e){this.position.x=e.x,this.position.y=e.y,this.ground=e.ground,this.updateMesh()}},{key:"attachBabylon",value:function(e){return Object(g.a)(Object(k.a)(i.prototype),"attachBabylon",this).call(this,e),this.mesh=l.j.CreatePlane("chunk",{width:1600,height:1600,sideOrientation:l.i.FRONTSIDE},this.scene),this.updateMesh(),this}},{key:"updateMesh",value:function(){var e=Object(p.a)(v.a.mark((function e(){var t,n,s,a,o;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.mesh&&this.scene){e.next=2;break}return e.abrupt("return");case 2:for(this.mesh.position=new l.u(16*this.position.x*100,16*-this.position.y*100,0),t=new l.f("chunkTexture",{width:16,height:16},this.scene,!0,l.r.NEAREST_NEAREST),n=t.getContext(),s=0;s<16;s++)for(a=0;a<16;a++)this.ground[s]&&this.ground[s][a]&&(n.fillStyle=i.getTerrainColor(this.ground[s][a]),n.fillRect(s,a,1,1),(s+a)%2===0&&(n.fillStyle="#00000005",n.fillRect(s,a,1,1)));t.update(),(o=new l.q("mat",this.scene)).emissiveTexture=t,this.mesh.material=o;case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"id",get:function(){return i.getId(this.position.x,this.position.y)}}],[{key:"getId",value:function(e,t){return e.toString()+"x"+t.toString()}},{key:"getTerrainColor",value:function(e){switch(e){case 1:return"#CFDA78";case 2:return"#4EDCF0";case 3:return"#6AA981";case 4:return"#FDDC86"}return"#DDDDDD"}}]),i}(E),M=function(){function e(){Object(r.a)(this,e),this.players=new A,this.chunks=new A}return Object(u.a)(e,[{key:"tickAll",value:function(e){this.players.forEach((function(t){return t.tick(e)})),this.chunks.forEach((function(t){return t.tick(e)}))}}]),e}(),A=function(){function e(){Object(r.a)(this,e),this.values={}}return Object(u.a)(e,[{key:"add",value:function(e,t){this.values[e]=t}},{key:"remove",value:function(e){this.includes(e)&&delete this.values[e]}},{key:"update",value:function(e,t,i){this.values[e].deserialize(t,i)}},{key:"updateOrCreate",value:function(e,t,i,n){this.includes(e)||(this.values[e]=i()),this.values[e].deserialize(t,n)}},{key:"get",value:function(e){return this.includes(e)?this.values[e]:null}},{key:"includes",value:function(e){return Object.keys(this.values).includes(e)}},{key:"forEach",value:function(e){var t=this;Object.keys(this.values).forEach((function(i,n){e(t.values[i],i,n)}))}},{key:"filter",value:function(e){var t=this,i=Object.keys(this.values),n=Object.assign({},this.values);return i.forEach((function(i,s){e(t.values[i],i,s)||delete n[i]})),n}}]),e}(),I={left:65,right:68,up:87,down:83},X=i(404),Y=i.n(X),z=function(){function e(t,i,n){Object(r.a)(this,e),this.apiUrl=t,this.scene=i,this.getBabylonScene=n,this.socket=void 0,this.userId=void 0,this.opened=void 0,this.callbacks={authenticated:function(){},updated:function(){}}}return Object(u.a)(e,[{key:"on",value:function(e,t){this.callbacks[e]=t}},{key:"close",value:function(){this.socket.disconnect()}},{key:"open",value:function(){var e=this;this.opened=!0,this.socket=Y()(this.apiUrl),this.setListeners(),this.socket.on("id",(function(t){e.userId=t,e.callbacks.authenticated({id:t}),console.log("Joined game with player ID: ",t)}))}},{key:"sendPlayerUpdate",value:function(e){this.socket.emit("update",{id:e.id,content:e.serialize()})}},{key:"requestChunk",value:function(e,t){this.socket.emit("mapRequest",{x:e,y:t})}},{key:"setListeners",value:function(){var e=this;this.socket.on("players",(function(t){e.scene.players.forEach((function(i,n){Object.keys(t).includes(n)?e.scene.players.get(n).setVisibility(!0):e.scene.players.get(n).setVisibility(!1)})),Object.keys(t).forEach((function(i){i!==e.userId&&e.scene.players.updateOrCreate(i,t[i],(function(){return new B(i).attachBabylon(e.getBabylonScene())}))}))})),this.socket.on("mapChunk",(function(t){var i=C.getId(t.x,t.y);e.scene.chunks.updateOrCreate(i,t,(function(){return new C(t.x,t.y).attachBabylon(e.getBabylonScene())}))}))}}]),e}();function D(e,t,i){var n=Math.floor(e)+8,s=Math.floor(t)+8,a=Math.floor(n/16),o=Math.floor(s/16),r=i.chunks.get(C.getId(a,o));return r&&r.ground[n-16*a]&&r.ground[n-16*a][s-16*o]?r.ground[n-16*a][s-16*o]:-1}var P=function(e){Object(h.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e)).gameScene=void 0,n.me=null,n.babylonScene=void 0,n.guiTexture=void 0,n.networkClient=void 0,n.state={},n.timer=void 0,n.gameScene=new M,n.networkClient=new z(n.props.apiUrl,n.gameScene,(function(){return n.babylonScene})),n.networkClient.on("authenticated",(function(e){return n.initGame(e.id)})),document.addEventListener("keydown",(function(e){n.me&&n.me.keyDown(e.keyCode)})),document.addEventListener("keyup",(function(e){n.me&&n.me.keyUp(e.keyCode)})),window.addEventListener("resize",(function(e){n.resize()})),n}return Object(u.a)(i,[{key:"componentDidMount",value:function(){this.resize(),this.networkClient.open()}},{key:"componentWillUnmount",value:function(){clearInterval(this.timer),this.networkClient.close()}},{key:"initGame",value:function(e){var t=this;this.me=new B(e),this.me.attachBabylon(this.babylonScene),this.me.bindKeys(I),this.gameScene.players.add(e,this.me),window.player=this.me,window.scene=this.gameScene,this.timer=setInterval((function(){t.me&&t.networkClient.sendPlayerUpdate(t.me)}),100)}},{key:"tick",value:function(e){if(this.gameScene.players.forEach((function(t){return t.tick(e)})),this.gameScene.chunks.forEach((function(e){return e.setVisibility(!1)})),this.me&&this.guiTexture){for(var t=-2;t<=2;t++)for(var i=-2;i<=2;i++){var n=Math.round(this.me.position.x/1600)+t,s=Math.round(this.me.position.y/1600)+i,a=C.getId(n,s);this.gameScene.chunks.includes(a)?this.gameScene.chunks.get(a).setVisibility(!0):(this.networkClient.requestChunk(n,s),this.gameScene.chunks.add(a,new C(n,s).attachBabylon(this.babylonScene)))}var o=this.guiTexture.getContext(),r=this.guiTexture.getSize().width,u=this.guiTexture.getSize().height;o.clearRect(0,0,r,u),function(e,t,i){var n=e.getContext(),s=e.getSize().width,a=(e.getSize().height,s-30-64);n.fillStyle="#000000",n.fillRect(a-64-3,17,136,136);for(var o=-32;o<=32;o++)for(var r=-32;r<=32;r++)n.fillStyle=C.getTerrainColor(D(i.position.x/100+o,i.position.y/100+r,t)),n.fillRect(a+2*o,84+2*r,2,2);n.fillStyle="#000000",n.font="15px Arial",n.textBaseline="top",n.textAlign="center",n.fillText(i?Math.round(i.position.x/100)+" \xd7 "+Math.round(i.position.y/100):"Not connected...",a,161),n.fillStyle="#00000020",n.fillRect(a-6,84,14,2),n.fillRect(a,78,2,14),e.update()}(this.guiTexture,this.gameScene,this.me),this.guiTexture.update()}}},{key:"resize",value:function(){var e=document.getElementById("game");e&&(e.width=window.innerWidth,e.height=window.innerHeight)}},{key:"onSceneMount",value:function(e){var t=this,i=e.scene;this.babylonScene=i;var n=new l.s("Camera",new l.u(0,0,1500),i);n.rotation=new l.u(0,0,0),this.guiTexture=y.a.CreateFullscreenUI("GUI",!0,i),i.getEngine().runRenderLoop((function(){t.tick(i.getEngine().getDeltaTime()),t.me&&(n.position=new l.u(t.me.position.x,-t.me.position.y,-1500)),i&&i.render()}))}},{key:"render",value:function(){var e=this;return s.a.createElement(s.a.Fragment,null,s.a.createElement(d.a,{antialias:!0,canvasId:"game"},s.a.createElement(d.b,{onSceneMount:function(t){return e.onSceneMount(t)}},s.a.createElement(s.a.Fragment,null))))}}]),i}(s.a.Component),R=function(e){Object(h.a)(i,e);var t=Object(c.a)(i);function i(){var e;Object(r.a)(this,i);for(var n=arguments.length,s=new Array(n),a=0;a<n;a++)s[a]=arguments[a];return(e=t.call.apply(t,[this].concat(s))).apiUrl="https://randombot-server.herokuapp.com/",e.state={status:"loading",textures:{loaded:0,of:0}},e}return Object(u.a)(i,[{key:"componentDidMount",value:function(){var e,t,i=this;this.setState({textures:{loaded:0,of:(e=function(){i.setState({status:"ingame"})},t=function(e,t){i.setState({textures:{loaded:e,of:t}})},0===b.length&&(t&&t(0,b.length),e()),b.forEach((function(i){w[i]=new Image,w[i].onload=function(){S++,t&&t(S,b.length),S===b.length&&e()},w[i].onerror=function(){console.error("Error loading resource file: ",i)},w[i].src=O+i})),b.length)}})}},{key:"render",value:function(){return s.a.createElement(s.a.Fragment,null,"loading"===this.state.status&&s.a.createElement("div",{style:{textAlign:"center"}},"Textures are loading (",this.state.textures.loaded,"/",this.state.textures.of,")"),"ingame"===this.state.status&&s.a.createElement(P,{apiUrl:this.apiUrl}))}}]),i}(s.a.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(s.a.createElement(s.a.StrictMode,null,s.a.createElement(R,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[405,1,2]]]);
//# sourceMappingURL=main.cc5ae2ce.chunk.js.map